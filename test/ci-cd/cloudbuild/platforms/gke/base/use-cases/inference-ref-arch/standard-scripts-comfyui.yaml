# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#Â  Â  Â http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

options:
Â  automapSubstitutions: true
Â  logging: CLOUD_LOGGING_ONLY

steps:
Â  - args:
Â  Â  Â  - "${_WAIT_FOR_TRIGGER}"
Â  Â  entrypoint: "test/ci-cd/scripts/cloudbuild/wait_for_trigger.sh"
Â  Â  env:
Â  Â  Â  - "LOCATION=${LOCATION}"
Â  Â  Â  - "PROJECT_ID=${PROJECT_ID}"
Â  Â  id: "Check triggers"
Â  Â  name: "${LOCATION}-docker.pkg.dev/${PROJECT_ID}/ci-cd/runner:latest"
Â  Â  waitFor: ["-"]

Â  - args:
Â  Â  Â  - DEBUG=${_DEBUG}
Â  Â  Â  - TF_VAR_platform_default_project_id="${PROJECT_ID}-$${PROJECT_SUFFIX}"
Â  Â  Â  - TF_VAR_platform_name="ch${SHORT_SHA}"
Â  Â  Â  - IAP_PROJECT_ID="${PROJECT_ID}-$${PROJECT_SUFFIX}"
Â  Â  Â  - TF_VAR_comfyui_iap_domain="accelerated-platforms.joonix.net"
Â  Â  entrypoint: "test/ci-cd/scripts/platforms/gke/base/configure_build_environment.sh"
Â  Â  env:
Â  Â  Â  - BUILD_ID=${BUILD_ID}
Â  Â  Â  - DEBUG=${_DEBUG}
Â  Â  Â  - PROJECT_ID=${PROJECT_ID}
Â  Â  Â  - SHORT_SHA=${SHORT_SHA}
Â  Â  id: "Configure the build environment"
Â  Â  name: "${LOCATION}-docker.pkg.dev/${PROJECT_ID}/ci-cd/runner:latest"
Â  Â  waitFor:
Â  Â  Â  - "Check triggers"

Â  - entrypoint: "test/ci-cd/scripts/cloudbuild/create_iap_brand.sh"
Â  Â  id: "Create the IAP Brand"
Â  Â  name: "${LOCATION}-docker.pkg.dev/${PROJECT_ID}/ci-cd/runner:latest"
Â  Â  waitFor:
Â  Â  Â  - "Configure the build environment"

Â  - args:
Â  Â  Â  - "Deploy platforms/gke/base/use-cases/inference-ref-arch/comfyui"
Â  Â  Â  - "platforms/gke/base/use-cases/inference-ref-arch/terraform/deploy-comfyui.sh"
Â  Â  entrypoint: "test/ci-cd/scripts/platforms/gke/base/run_deploy_script.sh"
Â  Â  id: "Deploy platforms/gke/base/use-cases/inference-ref-arch/comfyui"
Â  Â  name: "${LOCATION}-docker.pkg.dev/${PROJECT_ID}/ci-cd/runner:latest"
Â  Â  waitFor:
Â  Â  Â  - "Create the IAP Brand"
Â  
# ðŸ‘‡ New step added here
Â  - args:
Â  Â  Â  - "Test the ComfyUI deployment"
Â  Â  entrypoint: "test/ci-cd/scripts/comfyui/run_in_cluster.sh"
Â  Â  env:
Â  Â  Â  - HEADLESS_COMFYUI_SERVICE="http://comfyui-nvidia-l4.comfyui.svc.cluster.local:8188"
Â  Â  Â  - TEST_DIR="test/ci-cd/scripts/comfyui"
Â  Â  Â  - WORKFLOWS_DIR="/platforms/gke/base/use-cases/inference-ref-arch/terraform/comfyui/src/comfyui-workflows"
Â  Â  id: "Test ComfyUI test/ci-cd/scripts/comfyui"
Â  Â  name: "${LOCATION}-docker.pkg.dev/${PROJECT_ID}/ci-cd/runner:latest"
Â  Â  waitFor:
Â  Â  Â  - "Deploy platforms/gke/base/use-cases/inference-ref-arch/comfyui"

Â  - args:
Â  Â  Â  - platforms/gke/base/use-cases/inference-ref-arch/terraform
Â  Â  Â  - workflow_api
Â  Â  entrypoint: "test/ci-cd/scripts/terraservice/apply.sh"
Â  Â  id: "Apply inference-ref-arch Terraservice 'workflow_api'"
Â  Â  name: "${LOCATION}-docker.pkg.dev/${PROJECT_ID}/ci-cd/runner:latest"
Â  Â  waitFor:
Â  Â  Â  - "Test ComfyUI test/ci-cd/scripts/comfyui"

Â  - args:
Â  Â  Â  - platforms/gke/base/use-cases/inference-ref-arch/terraform
Â  Â  Â  - workflow_api
Â  Â  entrypoint: "test/ci-cd/scripts/terraservice/plan.sh"
Â  Â  id: "Check inference-ref-arch Terraservice 'workflow_api' check for changes"
Â  Â  name: "${LOCATION}-docker.pkg.dev/${PROJECT_ID}/ci-cd/runner:latest"
Â  Â  waitFor:
Â  Â  Â  - "Apply inference-ref-arch Terraservice 'workflow_api'"

Â  - args:
Â  Â  Â  - platforms/gke/base/use-cases/inference-ref-arch/terraform
Â  Â  Â  - workflow_api
Â  Â  entrypoint: "test/ci-cd/scripts/terraservice/destroy.sh"
Â  Â  id: "Destroy inference-ref-arch Terraservice 'workflow_api'"
Â  Â  name: "${LOCATION}-docker.pkg.dev/${PROJECT_ID}/ci-cd/runner:latest"
Â  Â  waitFor:
Â  Â  Â  - "Check inference-ref-arch Terraservice 'workflow_api' check for changes"

Â  - args:
Â  Â  Â  - "Teardown platforms/gke/base/use-cases/inference-ref-arch/comfyui"
Â  Â  Â  - "platforms/gke/base/use-cases/inference-ref-arch/terraform/teardown-comfyui.sh"
Â  Â  entrypoint: "test/ci-cd/scripts/platforms/gke/base/run_teardown_script.sh"
Â  Â  id: "Teardown platforms/gke/base/use-cases/inference-ref-arch/comfyui"
Â  Â  name: "${LOCATION}-docker.pkg.dev/${PROJECT_ID}/ci-cd/runner:latest"
Â  Â  waitFor:
Â  Â  Â  - "Destroy inference-ref-arch Terraservice 'workflow_api'"

Â  - args:
Â  Â  Â  - "Cleanup the build environment"
Â  Â  entrypoint: "test/ci-cd/scripts/platforms/gke/base/cleanup_build_environment.sh"
Â  Â  id: "Cleanup the build environment"
Â  Â  name: "${LOCATION}-docker.pkg.dev/${PROJECT_ID}/ci-cd/runner:latest"
Â  Â  waitFor:
Â  Â  Â  - "Teardown platforms/gke/base/use-cases/inference-ref-arch/comfyui"

Â  - entrypoint: "test/ci-cd/scripts/platforms/gke/base/set_build_status.sh"
Â  Â  id: "Set the build status"
Â  Â  name: "${LOCATION}-docker.pkg.dev/${PROJECT_ID}/ci-cd/runner:latest"
Â  Â  waitFor:
Â  Â  Â  - "Cleanup the build environment"

substitutions:
Â  _DEBUG: "false"

timeout: 90m"
